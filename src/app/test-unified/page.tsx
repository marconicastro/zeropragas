'use client';

/**
 * P√ÅGINA DE TESTE - SISTEMA UNIFICADO META PIXEL
 * 
 * VALIDA√á√ÉO COMPLETA DO NOVO SISTEMA
 */

import { useState, useEffect } from 'react';
import { 
  fireAllUnifiedEvents,
  validateUnifiedSystem,
  saveUserDataForEvents
} from '@/lib/unified-events-system';
import { 
  executeUrgentMigration,
  checkMigrationStatus,
  emergencyReset
} from '@/lib/urgent-migration';
import { getPersistedUserData } from '@/lib/userDataPersistence';

export default function TestUnifiedSystem() {
  const [migrationStatus, setMigrationStatus] = useState(false);
  const [persistedData, setPersistedData] = useState(null);
  const [testResults, setTestResults] = useState([]);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    // Verificar status inicial
    setMigrationStatus(checkMigrationStatus());
    setPersistedData(getPersistedUserData());
    
    // Auto-valida√ß√£o
    setTimeout(() => {
      validateUnifiedSystem();
    }, 1000);
  }, []);

  const addTestResult = (test, success, message) => {
    setTestResults(prev => [...prev, {
      test,
      success,
      message,
      timestamp: new Date().toLocaleTimeString()
    }]);
  };

  const handleMigration = async () => {
    setIsLoading(true);
    addTestResult('Migra√ß√£o Urgente', null, 'Executando migra√ß√£o...');
    
    try {
      const success = await executeUrgentMigration();
      setMigrationStatus(success);
      addTestResult('Migra√ß√£o Urgente', success, success ? '‚úÖ Migra√ß√£o conclu√≠da' : '‚ùå Falha na migra√ß√£o');
    } catch (error) {
      addTestResult('Migra√ß√£o Urgente', false, `‚ùå Erro: ${error.message}`);
    }
    
    setIsLoading(false);
  };

  const handleTestEvents = async () => {
    setIsLoading(true);
    addTestResult('Teste de Eventos', null, 'Disparando todos os eventos...');
    
    try {
      await fireAllUnifiedEvents();
      addTestResult('Teste de Eventos', true, '‚úÖ Todos os eventos disparados com sucesso');
    } catch (error) {
      addTestResult('Teste de Eventos', false, `‚ùå Erro: ${error.message}`);
    }
    
    setIsLoading(false);
  };

  const handleSaveTestData = () => {
    const testData = {
      email: 'test@example.com',
      phone: '11999999999',
      fullName: 'Usu√°rio Teste',
      city: 'S√£o Paulo',
      state: 'SP',
      cep: '01310-100'
    };
    
    saveUserDataForEvents(testData);
    setPersistedData(getPersistedUserData());
    
    addTestResult('Salvar Dados Teste', true, '‚úÖ Dados de teste salvos (Nota 9.3 garantida)');
  };

  const handleEmergencyReset = () => {
    if (confirm('‚ö†Ô∏è Isso limpar√° TODOS os dados. Tem certeza?')) {
      emergencyReset();
      setMigrationStatus(false);
      setPersistedData(null);
      setTestResults([]);
      addTestResult('Reset Emerg√™ncia', true, '‚úÖ Sistema resetado - recarregue a p√°gina');
    }
  };

  const handleValidation = () => {
    const hasData = validateUnifiedSystem();
    addTestResult('Valida√ß√£o Sistema', true, hasData ? '‚úÖ Dados persistidos encontrados' : '‚ö†Ô∏è Usar√° API geolocaliza√ß√£o');
  };

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header */}
        <div className="bg-white rounded-lg shadow p-6">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            üöÄ Teste - Sistema Unificado Meta Pixel
          </h1>
          <p className="text-gray-600">
            Valida√ß√£o completa do novo sistema unificado de eventos
          </p>
        </div>

        {/* Status Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className={`p-4 rounded-lg ${migrationStatus ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500'} border`}>
            <h3 className="font-semibold mb-2">Status Migra√ß√£o</h3>
            <p className="text-2xl">{migrationStatus ? '‚úÖ ATIVO' : '‚ùå INATIVO'}</p>
          </div>
          
          <div className={`p-4 rounded-lg ${persistedData ? 'bg-green-100 border-green-500' : 'bg-yellow-100 border-yellow-500'} border`}>
            <h3 className="font-semibold mb-2">Dados Persistidos</h3>
            <p className="text-2xl">{persistedData ? '‚úÖ SIM' : '‚ö†Ô∏è N√ÉO'}</p>
            {persistedData && (
              <p className="text-sm text-gray-600 mt-1">
                Nota 9.3 garantida
              </p>
            )}
          </div>
          
          <div className="p-4 rounded-lg bg-blue-100 border-blue-500 border">
            <h3 className="font-semibold mb-2">Sistema</h3>
            <p className="text-2xl">üîÑ UNIFICADO</p>
            <p className="text-sm text-gray-600 mt-1">
              v2.0.0
            </p>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-semibold mb-4">A√ß√µes de Teste</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <button
              onClick={handleMigration}
              disabled={isLoading || migrationStatus}
              className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
            >
              {isLoading ? '‚è≥ Executando...' : 'üöÄ Executar Migra√ß√£o'}
            </button>
            
            <button
              onClick={handleTestEvents}
              disabled={isLoading}
              className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
            >
              {isLoading ? '‚è≥ Testando...' : 'üß™ Testar Eventos'}
            </button>
            
            <button
              onClick={handleSaveTestData}
              className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700"
            >
              üíæ Salvar Dados Teste
            </button>
            
            <button
              onClick={handleValidation}
              className="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700"
            >
              üîç Validar Sistema
            </button>
            
            <button
              onClick={() => setTestResults([])}
              className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
            >
              üóëÔ∏è Limpar Logs
            </button>
            
            <button
              onClick={handleEmergencyReset}
              className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
            >
              üö® Reset Emerg√™ncia
            </button>
          </div>
        </div>

        {/* Test Results */}
        {testResults.length > 0 && (
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-semibold mb-4">Resultados dos Testes</h2>
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {testResults.map((result, index) => (
                <div 
                  key={index}
                  className={`p-3 rounded ${result.success ? 'bg-green-50' : result.success === null ? 'bg-yellow-50' : 'bg-red-50'}`}
                >
                  <div className="flex justify-between items-start">
                    <div>
                      <span className="font-medium">{result.test}</span>
                      <p className="text-sm text-gray-600">{result.message}</p>
                    </div>
                    <span className="text-xs text-gray-500">{result.timestamp}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Instructions */}
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-semibold mb-4">Instru√ß√µes de Uso</h2>
          <div className="space-y-3 text-sm">
            <div className="flex items-start space-x-2">
              <span className="text-green-600">1Ô∏è‚É£</span>
              <p>
                <strong>Execute a Migra√ß√£o:</strong> Clique em "Executar Migra√ß√£o" para ativar o sistema unificado.
              </p>
            </div>
            <div className="flex items-start space-x-2">
              <span className="text-green-600">2Ô∏è‚É£</span>
              <p>
                <strong>Salve Dados Teste:</strong> Clique em "Salvar Dados Teste" para simular um lead preenchido.
              </p>
            </div>
            <div className="flex items-start space-x-2">
              <span className="text-green-600">3Ô∏è‚É£</span>
              <p>
                <strong>Teste Eventos:</strong> Clique em "Testar Eventos" para disparar todos os eventos com dados completos.
              </p>
            </div>
            <div className="flex items-start space-x-2">
              <span className="text-green-600">4Ô∏è‚É£</span>
              <p>
                <strong>Verifique Resultados:</strong> Observe os logs no console e os resultados aqui na p√°gina.
              </p>
            </div>
          </div>
        </div>

        {/* Expected Results */}
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-semibold mb-4">Resultados Esperados</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <h3 className="font-semibold text-green-600 mb-2">Com Dados Persistidos:</h3>
              <ul className="space-y-1">
                <li>‚úÖ PageView: Nota 9.3</li>
                <li>‚úÖ ViewContent: Nota 9.3</li>
                <li>‚úÖ ScrollDepth: Nota 9.3</li>
                <li>‚úÖ CTAClick: Nota 9.3</li>
                <li>‚úÖ Lead: Nota 9.3</li>
                <li>‚úÖ InitiateCheckout: Nota 9.3</li>
              </ul>
            </div>
            <div>
              <h3 className="font-semibold text-blue-600 mb-2">Sem Dados Persistidos:</h3>
              <ul className="space-y-1">
                <li>üåê PageView: Nota 8.0+</li>
                <li>üåê ViewContent: Nota 8.0+</li>
                <li>üåê ScrollDepth: Nota 8.0+</li>
                <li>üåê CTAClick: Nota 8.0+</li>
                <li>üåê Lead: Nota 8.0+</li>
                <li>üåê InitiateCheckout: Nota 8.0+</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}